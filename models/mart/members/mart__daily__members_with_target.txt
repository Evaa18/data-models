{{ config(materialized='table') }}

WITH target AS (
    SELECT
        targeted_at,
        target_audience,
        MIN(target_value__created_members) AS target_value__created_members
    FROM
        {{ ref('base__google_sheets__target_created_members') }}
    GROUP BY ALL
)

SELECT
    COALESCE(DATE(measured_at), targeted_at) AS measured_at,
    COALESCE(member_type, target_audience) AS member_type,
    ambassador_company_name,
    company_sector_name,
    address_country,
    address_administrative_area_level_1_region_fr,
    address_administrative_area_level_2_department_fr,
    address_city_fr,
    address_postal_code,
    COUNT(DISTINCT
        IF(
            member_is_created,
            seeker_id,
            NULL
        )
    ) AS new_members_created,
    COUNT(DISTINCT
        IF(
            member_is_activated,
            seeker_id,
            NULL
        )
    ) AS new_members_activated,
    target_value__created_members
FROM
    {{ ref('int__marketplace__members_history_filled') }} AS members_filled
FULL OUTER JOIN
    target
    ON DATE(members_filled.measured_at) = target.targeted_at
    AND members_filled.member_type = target.target_audience
GROUP BY ALL
