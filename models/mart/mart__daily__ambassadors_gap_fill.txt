{{ config(materialized='table') }}

SELECT
    {{ dbt_utils.date_spine( datepart="day", start_date="MIN(user_created_at)", end_date="CURRENT_DATE()", ) }}
    calendar.user_created_at AS measured_at,
    ambassadors.ambassador_company_name,
    ambassadors.ambassador_job_title,
    ambassadors.address_country,
    ambassadors.address_administrative_area_level_1_region_fr,
    ambassadors.address_administrative_area_level_2_department_fr,
    ambassadors.address_administrative_area_level_3_fr,
    COUNT(DISTINCT
        IF(
            ambassador_is_published,
            ambassadors.ambassador_id,
            NULL
        )
    ) AS ambassadors_published_total
FROM
    GAP_FILL(
        TABLE {{ ref('int__marketplace__ambassadors') }},
        ts_column => 'user_created_at',
        bucket_width => INTERVAL 1
    ) AS calendar
LEFT JOIN
    {{ ref('int__marketplace__ambassadors') }} AS ambassadors
    ON calendar.user_created_at = ambassadors.user_created_at
LEFT JOIN
    {{ ref('base__dbt_transformations__snapshot_ambassadors_status') }} AS ambassadors_snapshot
    ON calendar.user_created_at >= ambassadors_snapshot.dbt_valid_from
    AND (calendar.user_created_at <= ambassadors_snapshot.dbt_valid_to
        OR ambassadors_snapshot.dbt_valid_to IS NULL)
{{ dbt_utils.group_by(7) }}
